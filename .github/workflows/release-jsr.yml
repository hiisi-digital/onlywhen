name: Release to JSR

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Perform a dry run (don't actually publish)"
        required: false
        default: "true"
        type: boolean

env:
  JSR_PACKAGE_NAME: "@hiisi/onlywhen"

jobs:
  publish:
    name: Publish to JSR
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Extract version info
        id: version
        run: |
          PKG_VERSION=$(deno eval "const c = JSON.parse(Deno.readTextFileSync('deno.json')); console.log(c.version)")
          PKG_NAME=$(deno eval "const c = JSON.parse(Deno.readTextFileSync('deno.json')); console.log(c.name)")
          echo "version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "Package: $PKG_NAME@$PKG_VERSION"

      - name: Verify version matches tag
        if: github.event_name == 'push'
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PKG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match package version ($PKG_VERSION)"
            echo "Please update deno.json version to match the tag."
            exit 1
          fi
          echo "Version verified: $TAG_VERSION"

      - name: Format check
        run: deno fmt --check

      - name: Lint
        run: deno lint

      - name: Type check
        run: deno check mod.ts

      - name: Run tests
        run: deno test --allow-read --allow-write --allow-env --allow-run

      - name: Verify publish configuration
        run: |
          echo "Checking publish configuration..."
          deno eval '
            const config = JSON.parse(Deno.readTextFileSync("deno.json"));
            
            if (!config.name) {
              console.error("Missing name in deno.json");
              Deno.exit(1);
            }
            
            if (!config.version) {
              console.error("Missing version in deno.json");
              Deno.exit(1);
            }
            
            if (!config.exports) {
              console.error("Missing exports in deno.json");
              Deno.exit(1);
            }
            
            console.log("Publish configuration valid:");
            console.log("  Name:", config.name);
            console.log("  Version:", config.version);
            console.log("  License:", config.license);
            
            if (config.publish?.include) {
              console.log("  Include:", config.publish.include.length, "entries");
            }
            if (config.publish?.exclude) {
              console.log("  Exclude:", config.publish.exclude.length, "entries");
            }
          '

      - name: Dry run publish
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "Performing dry run..."
          deno publish --dry-run
          echo ""
          echo "Dry run completed. No package was published."

      - name: Publish to JSR
        if: github.event.inputs.dry_run != 'true'
        run: deno publish

      - name: Post-publish info
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo ""
          echo "Published ${{ steps.version.outputs.name }}@${{ steps.version.outputs.version }} to JSR"
          echo ""
          echo "Install with:"
          echo '  import { onlywhen } from "jsr:${{ steps.version.outputs.name }}";'
          echo ""
          echo "Or add to deno.json:"
          echo '  "${{ steps.version.outputs.name }}": "jsr:${{ steps.version.outputs.name }}@^${{ steps.version.outputs.version }}"'
